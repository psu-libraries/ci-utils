version: 2.1

orbs:
  docker: circleci/docker@2.6.0

jobs:

  build-and-push:
    environment:
      REGISTRY_HOST: harbor.k8s.libraries.psu.edu
      REGISTRY_REPO: library/ci-utils
      TAG: << parameters.version >>
    executor: docker/docker
    parameters:
      version:
        type: string
    steps:
    - setup_remote_docker
    - checkout
    - docker/check:
        registry: $REGISTRY_HOST
    - docker/build:
        image: $REGISTRY_REPO
        registry: $REGISTRY_HOST
        tag: $TAG
    - docker/push:
        image: $REGISTRY_REPO
        registry: $REGISTRY_HOST
        tag: $TAG

  tag-image:
    environment:
      REGISTRY_HOST: harbor.k8s.libraries.psu.edu
      REGISTRY_REPO: library/ci-utils
      TAG: << parameters.version >>
    executor: docker/docker
    parameters:
      version:
        type: string
    steps:
      - setup_remote_docker
      - checkout
      - run:
          name: "tag image"
          command: |
            export REGISTRY_REPO=$REGISTRY_REPO
            /usr/local/bin/tag-image

workflows:

  docker_push:
    jobs:
      - build-and-push:
          context:
            - org-global
          filters:
            branches:
              only:
                - master
                - jimtest
          version: "latest"
      - tag-image:
          context:
            - org-global
          filters:
            branches:
              ignore:
                  - /.*/
            tags:
              only:
                - /^v\d+.*/
          name: "tag image"
          version: "$CIRCLE_TAG"
